---
title: "Exploratory Spatial Data Analysis"
subtitle: "STEC project"
author: "Lorena Abad"
date: "February 4, 2021"
output: 
  html_document: 
    toc: true
    toc_depth: 2
    toc_float: true
---
## Setup

```{r Libraries}
library(here)
library(sf)
library(stars)
library(tidyverse, quietly = T, warn.conflicts = F)
library(mapview)
library(ggforce)
library(patchwork)

```
```{r Directories}
stec_dir = "R:/RESEARCH/02_PROJECTS/01_P_330001/119_STEC/04_Data/Gullies-Mangatu"

```
```{r Data}
# g57 = st_read(here(stec_dir, 'Mangatu_feature_extraction', 'gullies_57_tm.shp'))
# g97_1 = st_read(here(stec_dir, 'Mangatu_feature_extraction', 'gullies_97_tm.shp'))
# g97_2 = st_read(here(stec_dir, 'Mangatu_feature_extraction', 'gullies_97_f_tm.shp'))
g39 = st_read(here(stec_dir, 'mangatu_coregistered_LA', 'mangatu_1939_ero_feat_nztm.shp'))
g60 = st_read(here(stec_dir, 'mangatu_coregistered_LA', 'mangatu_1960_ero_feat_nztm.shp'))
g70 = st_read(here(stec_dir, 'mangatu_coregistered_LA', 'mangatu_1970_ero_feat_nztm.shp'))
g88 = st_read(here(stec_dir, 'Mangatu_feature_extraction', 'mangatu_1988_ero_feat_nztm.shp'))
```

## Explore
First I will combine all the data into one single object to better explore 
and summarize variables


```{r Combine}
# Establish some common variables
gully = list(g39, g60, g70, g88)
year = c(1939, 1960, 1970, 1988)
colnames = names(g39)
# Create function to harmonize datasets
prepare_for_merge = function(x, y) {
  z = mutate(x, year = y)
  names(z) = c(colnames, 'year')
  z
}
# Merge data
l = purrr::map2(gully, year, prepare_for_merge)
gully_merge = do.call(rbind, l) %>% 
  mutate_if(is.character, factor)
```

Now that we have one single file, we can take a look at some of the attributes.
### Features per year
We can summarize our data to check how many erosion features we have per year


```{r Explore1}
e1 = gully_merge %>% 
  st_drop_geometry() %>% 
  group_by(year) %>% 
  summarise(
    feature_count = n(), 
    total_area = sum(Shape_Area), 
    total_length = sum(Shape_Leng)
  ) %>% 
  ungroup() 

e1 %>% 
  knitr::kable()

e1 %>% 
  pivot_longer(-year, names_to = 'indicator') %>% 
  ggplot(aes(x = year, y = value)) +
  geom_line() +
  geom_point() +
  facet_wrap(~indicator, scales = 'free_y', nrow = 3)
```

Let's take a look now at the variation of the indicators per feature and year

```{r Explore2, fig.show = 'hold'}
d = gully_merge %>% 
  st_drop_geometry() %>% 
  select(-c(EROS, eros_feat_)) %>% 
  group_by(year) %>% 
  pivot_longer(-year, names_to = 'indicator')
  
d %>% 
  filter(indicator == "Shape_Area") %>%
  ggplot(aes(x = as.factor(year), y = value)) +
  geom_boxplot() +
  facet_zoom(ylim = c(0, 5e4))
d %>% 
  filter(indicator == "Shape_Leng") %>%
  ggplot(aes(x = as.factor(year), y = value)) +
  geom_boxplot() +
  facet_zoom(ylim = c(0, 2e3))
```

### Erosion features 
There are two columns that refer to this variable `EROS` and `eros_feat_`. 
I initially thought `EROS` was an acronym way to represent the long name
description in `eros_feat_`, but when I group by both features and get a count,
we can see that "Aggraded riverbed" is represented with three different 
types of `EROS` values. These are not many features, in these categories, 
summing up to **40** elements, but it would be still worth to check what they are.

```{r Explore3}
gully_merge %>% 
  st_drop_geometry() %>% 
  group_by(EROS, eros_feat_) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  knitr::kable()

```
```{r render, eval = F, include = F}
o = knitr::spin('esda.R', knit = FALSE)
rmarkdown::render(o)
```

